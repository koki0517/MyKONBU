---
layout: default
title: "ev3fast"
tags: ev3 ev3-micropython
---

# PID制御でライントレースするときの注意点

# はじめに
我ら学生のロボット大会では、[PID制御](https://e-sysnet.com/seigyo3/)がライントレースによく用いられます。<br>
ここではPID制御の内、I制御に関して書いていきます。<br>

# I制御とは
[https://e-sysnet.com/seigyo3/](https://e-sysnet.com/seigyo3/)によるとI制御とは<br>
> 積分動作（I）は偏差を時間的に蓄積し、蓄積した量がある大きさになった所で、操作量を増やして偏差を無くすように動作させます。

![image.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/2449798/67ab2241-9bea-3329-56af-81cff095a804.png)

ここで注目したいのが「偏差を"**時間的**"に蓄積」という部分です。<br>
もし時間的に蓄積しない。つまり、最初から最後までの偏差をすべて蓄積してしまうとどうなるか。<br>

結論から言えば、**ライントレースが成り立たなくなる恐れ**があります。<br>

例えば、上の図の50s付近において、I制御で残留偏差をなくすのに必要となるのは青矢印で示されれている範囲になります。<br>
そして、それ以前0s~30sの範囲は50s時点での残留偏差を示さないため必要ありません。これをI制御に含めてしまうと、当時の残留偏差に関係なく積分値が巨大になってしまいます。<br>

もちろんこれでもPID制御は成り立つのですが、**本来必要のない値が蓄積されすぎる**とP制御やD制御に影響を及ぼす恐れがあります。<br>

なので、**I制御では偏差を時間的に蓄積(積分)しましょう**。<br>
※積分する範囲は制御周期や環境によって変わってきます。<br>

# たまに見る
最初から最後までの偏差をすべて蓄積するPID制御のコードをネット上に散見します。ですが、ロボット大会でのライントレースは直線となめらかな曲線だけではなく、急カーブ・直角などなど鬼畜なコースがたくさん待っています。最初から最後までの偏差をすべて蓄積するのは避けるべきでしょう。<br>

ネット上にあるコードでは以下のように、現在の偏差と前回制御での偏差を足す場合が多いです。<br>
もうちょっと多く蓄積したほうがいい気もしますけどね…<br>
```pid_control_sample.py
#!/usr/bin/env pybricks-micropython
from pybricks.ev3devices import Motor, ColorSensor
from pybricks.parameters import Port, Direction, Color

left_color = ColorSeneor(Port.S1)
right_color = ColorSeneor(Port.S2)

left_motor = Motor(Port.1)
right_motor = Motor(Port.2)

class Tank:
    Kp = 1.2 # Pゲイン
    Ki = 0.5 # Iゲイン
    Kd = 1.0 # Dゲイン
    last_error = 0

    def drive_pid(self, base_speed):
        error = left_color.refrection() - right_color.refrection() # 現在の偏差を求める
        sum_control_amount = (Tank.Kp * error + Tank.Ki * (error + Tank.last_error) + Tank.Kd * (error - Tank.last_error) # PID制御の操作量を計算
        left_motor.run(base_speed + sum_control_amount) # 走る
        right_motor.run(base_speed - sum_control_amount)
        last_error = error

tank = Tank()

while True:
    tank.drive_pid(50) # 50%のパワーでライントレースし続ける
```

# 参考文献
[https://e-sysnet.com/seigyo3/](https://e-sysnet.com/seigyo3/)
